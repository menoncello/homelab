#cloud-config
package_update: true
package_upgrade: true
packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - docker.io
  - docker-compose
  - qemu-guest-agent
  - net-tools
  - unzip

runcmd:
  - systemctl enable docker
  - systemctl start docker
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - usermod -aG docker ubuntu

write_files:
  - path: /etc/ssh/sshd_config
    content: |
      PasswordAuthentication no
      PubkeyAuthentication yes
      PermitRootLogin no
    append: true

  - path: /etc/motd
    content: |
      ========================================
      Homelab VM - Managed by Terraform
      ========================================
      Node: ${hostname}
      IP: ${ip_address}
      Managed by Terraform
      ========================================
    permissions: '0644'

  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        }
      }
    permissions: '0644'

  - path: /etc/environment
    content: |
      LC_ALL=en_US.UTF-8
      LANG=en_US.UTF-8
    append: true

# Create docker user
users:
  - name: ubuntu
    groups: docker, sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

# Network configuration (optional)
network:
  version: 2
  ethernets:
    ens18:
      dhcp4: false
      addresses:
        - ${ip_address}/24
      gateway4: ${gateway}
      nameservers:
        addresses: [1.1.1.1, 8.8.8.8]