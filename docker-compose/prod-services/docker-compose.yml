version: '3.8'

services:
  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud
    ports:
      - "8081:80"
    volumes:
      - nextcloud_data:/var/www/html
      - /files:/var/www/html/data
    environment:
      - MYSQL_HOST=192.168.31.203
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - REDIS_HOST=192.168.31.203
      - REDIS_PORT=6379
      - TRUSTED_PROXIES=192.168.31.0/24
      - OVERWRITEPROTOCOL=https
    restart: unless-stopped
    networks:
      - prod-services
    depends_on:
      - redis

  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    ports:
      - "3000:3000"
      - "222:22"
    volumes:
      - gitea_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=mysql
      - GITEA__database__HOST=192.168.31.203:3306
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=${GITEA_DB_PASSWORD}
      - GITEA__server__DOMAIN=gitea.${DOMAIN}
      - GITEA__server__ROOT_URL=https://gitea.${DOMAIN}
    restart: unless-stopped
    networks:
      - prod-services

  immich:
    image: immich/immich-server:latest
    container_name: immich
    ports:
      - "2283:3001"
    volumes:
      - immich_upload:/usr/src/app/upload
      - /photos:/usr/src/app/upload/library
      - immich_photos:/usr/src/app/photos
    environment:
      - REDIS_HOST=192.168.31.203
      - DB_HOST=192.168.31.203
      - DB_PORT=5432
      - DB_USERNAME=immich
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=immich
      - IMMICH_VERSION=v1.104.0
    restart: unless-stopped
    networks:
      - prod-services

  bookstack:
    image: linuxserver/bookstack:latest
    container_name: bookstack
    ports:
      - "8084:80"
    volumes:
      - bookstack_config:/config
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Sao_Paulo
      - APP_URL=https://wiki.${DOMAIN}
      - DB_HOST=192.168.31.203:3306
      - DB_USER=bookstack
      - DB_PASS=${BOOKSTACK_DB_PASSWORD}
      - DB_DATABASE=bookstack
    restart: unless-stopped
    networks:
      - prod-services

  taiga:
    image: taigaio/taiga-back:latest
    container_name: taiga-back
    ports:
      - "8085:8000"
    volumes:
      - taiga_media:/taiga-back/media
      - taiga_static:/taiga-back/static
    environment:
      - POSTGRES_HOST=192.168.31.203
      - POSTGRES_DB=taiga
      - POSTGRES_USER=taiga
      - POSTGRES_PASSWORD=${TAIGA_DB_PASSWORD}
      - SECRET_KEY=${TAIGA_SECRET_KEY}
    restart: unless-stopped
    networks:
      - prod-services

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    ports:
      - "8086:8080"
    volumes:
      - vaultwarden_data:/data
    environment:
      - SIGNUPS_ALLOWED=false
      - WEBSOCKET_ENABLED=true
      - WEBSOCKET_ADDRESS=0.0.0.0
      - WEBSOCKET_PORT=3012
      - DATABASE_URL=postgresql://vaultwarden:${VAULTWARDEN_DB_PASSWORD}@192.168.31.203:5432/vaultwarden
      - ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN}
    restart: unless-stopped
    networks:
      - prod-services

  freshrss:
    image: freshrss/freshrss:latest
    container_name: freshrss
    ports:
      - "8087:80"
    volumes:
      - freshrss_data:/var/www/FreshRSS/data
      - freshrss_extensions:/var/www/FreshRSS/extensions
    environment:
      - TZ=America/Sao_Paulo
      - CRON_MIN=1,31
    restart: unless-stopped
    networks:
      - prod-services

  ghost:
    image: ghost:latest
    container_name: ghost
    ports:
      - "8088:2368"
    volumes:
      - ghost_content:/var/lib/ghost/content
    environment:
      - url=https://blog.${DOMAIN}
      - database__client=mysql
      - database__connection__host=192.168.31.203
      - database__connection__user=ghost
      - database__connection__password=${GHOST_DB_PASSWORD}
      - database__connection__database=ghost
      - mail__transport=SMTP
      - mail__options__service=Gmail
      - mail__options__auth__user=your-email@gmail.com
      - mail__options__auth__pass=your-app-password
    restart: unless-stopped
    networks:
      - prod-services

  redis:
    image: redis:7-alpine
    container_name: redis-local
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    networks:
      - prod-services

volumes:
  nextcloud_data:
  gitea_data:
  immich_upload:
  immich_photos:
  bookstack_config:
  taiga_media:
  taiga_static:
  vaultwarden_data:
  freshrss_data:
  freshrss_extensions:
  ghost_content:
  redis_data:

networks:
  prod-services:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/16