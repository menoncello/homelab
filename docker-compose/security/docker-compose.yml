# ============================================
# HOMELAB SECURITY STACK
# HashiCorp Vault + Authentication Methods
# ============================================

version: '3.8'

services:
  # HashiCorp Vault - Enterprise Secrets Management
  vault:
    image: hashicorp/vault:1.15.6
    container_name: vault
    restart: unless-stopped
    ports:
      - "8200:8200"
    environment:
      VAULT_ADDR: "http://0.0.0.0:8200"
      VAULT_LOCAL_CONFIG: |
        ui = true

        listener "tcp" {
          address = "0.0.0.0:8200"
          tls_disable = 1
        }

        storage "file" {
          path = "/vault/data"
        }

        api_addr = "http://0.0.0.0:8200"
        cluster_addr = "http://0.0.0.0:8201"

        # Enable AppRole auth for your custom services
        auth "approle" {
          type = "approle"
        }

        # Enable userpass for admin access
        auth "userpass" {
          type = "userpass"
        }

        # Database secrets engine
        database "mysql" {
          plugin_name = "mysql-database-plugin"
          connection_url = "{{username}}:{{password}}@tcp(mysql:3306)/"
          allowed_roles = ["homelab-app", "homelab-readonly"]
        }

        database "postgresql" {
          plugin_name = "postgresql-database-plugin"
          connection_url = "postgresql://{{username}}:{{password}}@postgresql:5432/postgres?sslmode=disable"
          allowed_roles = ["homelab-app", "homelab-readonly"]
        }

        # PKI secrets engine for internal certificates
        pki "homelab-pki" {
          type = "pki"
          default_lease_ttl = "8760h"
          max_lease_ttl = "87600h"
        }
      VAULT_ROOT_TOKEN_ID: "${VAULT_ROOT_TOKEN}"
      VAULT_DEV_ROOT_TOKEN_ID: "${VAULT_ROOT_TOKEN}"
    volumes:
      - vault_data:/vault/data
      - ./config:/vault/config
      - ./policies:/vault/policies
    cap_add:
      - IPC_LOCK
    networks:
      - homelab-network
    labels:
      - "com.homelab.service=vault"
      - "com.homelab.category=security"

  # Vault Unsealer (for production HA)
  vault-unsealer:
    image: ghcr.io/banzaicloud/bank-vaults:latest
    container_name: vault-unsealer
    restart: unless-stopped
    environment:
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "${VAULT_ROOT_TOKEN}"
    entrypoint: >
      sh -c "
      sleep 10;
      bank-vaults unseal --init --root-token=${VAULT_ROOT_TOKEN};
      while true; do sleep 3600; done
      "
    depends_on:
      - vault
    networks:
      - homelab-network
    profiles:
      - production

  # Vault UI Proxy (optional enhanced UI)
  vault-ui:
    image: nginx:alpine
    container_name: vault-ui-proxy
    restart: unless-stopped
    ports:
      - "8000:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - vault
    networks:
      - homelab-network
    profiles:
      - enhanced-ui
    labels:
      - "com.homelab.service=vault-ui"
      - "com.homelab.category=security"

networks:
  homelab-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  vault_data:
    driver: local