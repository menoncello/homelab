version: '3.8'

services:
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx-proxy-manager
    ports:
      - '80:80'     # Public HTTP Port
      - '443:443'   # Public HTTPS Port
      - '81:81'     # Admin Web Port
    volumes:
      - npm_data:/data
      - npm_letsencrypt:/etc/letsencrypt
      - ./config/nginx.conf:/etc/nginx/conf.d/custom.conf
      - ./config/ssl:/etc/nginx/ssl:ro
    environment:
      - DISABLE_IPV6=true
      - TZ=America/Sao_Paulo
    restart: unless-stopped
    networks:
      - nginx-proxy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:81/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Certbot for additional SSL certificates
  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    volumes:
      - npm_letsencrypt:/etc/letsencrypt
      - ./config/certbot:/etc/certbot
    command: >
      sh -c "
      while :; do
        certbot renew --quiet --no-self-upgrade
        sleep 12h
      done
      "
    restart: unless-stopped
    networks:
      - nginx-proxy

  # CrowdSec for security
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    ports:
      - "8080:8080"
    volumes:
      - crowdsec_db:/var/lib/crowdsec/data
      - crowdsec_config:/etc/crowdsec
      - /var/log:/var/log:ro
    environment:
      - GID=1000
      - COLLECTIONS=crowdsecurity/nginx
      - BOUNCER_KEY_NGINX=${CROWDSEC_BOUNCER_KEY}
    restart: unless-stopped
    networks:
      - nginx-proxy

  # CrowdSec Bouncer for NPM
  crowdsec-bouncer:
    image: fbonalair/traefik-crowdsec-bouncer:latest
    container_name: crowdsec-bouncer
    volumes:
      - ./config/crowdsec-bouncer.yaml:/etc/crowdsec-bouncer.yaml:ro
    environment:
      - CROWDSEC_BOUNCER_KEY=${CROWDSEC_BOUNCER_KEY}
      - CROWDSEC_LAPI_URL=http://crowdsec:8080
    restart: unless-stopped
    networks:
      - nginx-proxy
    depends_on:
      - crowdsec

volumes:
  npm_data:
  npm_letsencrypt:
  crowdsec_db:
  crowdsec_config:

networks:
  nginx-proxy:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16