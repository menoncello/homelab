# Stacks Stack
# Download manager for Anna's Archive
# Deploy with: docker stack deploy -c stacks/stacks-stack/docker-compose.yml stacks

version: '3.8'

services:
  stacks:
    image: zelest/stacks:latest
    hostname: stacks
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.storage == true
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
      restart_policy:
        condition: any
    environment:
      - USERNAME=admin
      - PASSWORD=admin123
      - SOLVERR_URL=http://flaresolverr:8191
      - TZ=America/Sao_Paulo
    volumes:
      - stacks-config:/config
      - stacks-downloads:/downloads
      - stacks-logs:/logs
    networks:
      - homelab-net
    ports:
      - target: 7788
        published: 7788
        protocol: tcp
        mode: host

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    hostname: flaresolverr
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.storage == true
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      restart_policy:
        condition: any
    environment:
      - LOG_LEVEL=info
    networks:
      - homelab-net
    ports:
      - target: 8191
        published: 8191
        protocol: tcp
        mode: host

networks:
  homelab-net:
    external: true
    name: homelab-net

volumes:
  stacks-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /srv/docker/stacks/config

  stacks-downloads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /srv/docker/books

  stacks-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /srv/docker/stacks/logs
