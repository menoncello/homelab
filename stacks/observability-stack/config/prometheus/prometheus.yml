global:
  scrape_interval: 15s
  external_labels:
    cluster: 'homelab'
    env: 'production'
    datacenter: 'home'

scrape_configs:
  # Docker Swarm service discovery
  - job_name: 'dockerswarm'
    dockerswarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: tasks
    relabel_configs:
      # Keep only services with prometheus.io.scrape=true
      - source_labels: [__meta_dockerswarm_service_label_prometheus_io_scrape]
        regex: 'true'
        action: keep
      # Set job from service name
      - source_labels: [__meta_dockerswarm_service_name]
        target_label: job
        regex: 'observability_(.+)'
        replacement: '${1}'
      # Set instance from node hostname
      - source_labels: [__meta_dockerswarm_node_hostname]
        target_label: instance
      # Set service label
      - source_labels: [__meta_dockerswarm_service_name]
        target_label: service
      # Port from label or default
      - source_labels: [__meta_dockerswarm_service_label_prometheus_io_port]
        target_label: __meta_dockerswarm_task_container_port_number
        regex: '(.+)'
      # Add all prometheus.io labels
      - regex: __meta_dockerswarm_service_label_prometheus_io_(.+)
        action: labelmap
        replacement: __meta_${1}

  # Static target for VictoriaMetrics self-monitoring
  - job_name: 'victoriametrics'
    static_configs:
      - targets: ['localhost:8428']
        labels:
          instance: 'xenon01'
