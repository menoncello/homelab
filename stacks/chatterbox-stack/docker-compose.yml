# Chatterbox TTS API Stack
# FastAPI-powered OpenAI-compatible TTS API with voice cloning
# Based on: https://github.com/travisvn/chatterbox-tts-api

version: '3.8'

services:
  chatterbox-api:
    image: travisvn/chatterbox-tts-api:latest
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.gpu == true
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.chatterbox.rule=Host(`chatterbox.homelab.local`)"
        - "traefik.http.routers.chatterbox.entrypoints=web"
        - "traefik.http.services.chatterbox.loadbalancer.server.port=4123"
    environment:
      - TZ=America/Sao_Paulo
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility,graphics
      - PORT=4123
      - USE_MULTILINGUAL_MODEL=true
      - DEVICE=cuda
    volumes:
      # HuggingFace cache for models
      - chatterbox-models:/cache
      # Voice library for cloned voices
      - chatterbox-voices:/app/voices
      # Output directory for generated audio
      - /media/audiobooks:/app/output:rw
    networks:
      - homelab-net
    ports:
      - target: 4123
        published: 4123
        protocol: tcp
        mode: host
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4123/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  homelab-net:
    external: true

volumes:
  chatterbox-models:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/docker/chatterbox/models

  chatterbox-voices:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/docker/chatterbox/voices
