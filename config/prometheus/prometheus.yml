# Prometheus Configuration for Homelab Monitoring
# ================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'homelab'
    environment: 'production'

# Rule files for alerting
rule_files:
  - "rules/*.yml"

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Scrape configurations
scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 5s

  # Node Exporter - System metrics
  - job_name: 'node-exporter'
    static_configs:
      - targets:
        - 'node-exporter:9100'
        - '192.168.31.151:9100'  # media-server
        - '192.168.31.201:9100'  # infra-monitoring
        - '192.168.31.202:9100'  # prod-services
        - '192.168.31.203:9100'  # databases
        - '192.168.31.205:9100'  # books-server
        - '192.168.31.206:9100'  # storage-server
        - '192.168.31.207:9100'  # devops-server
    scrape_interval: 30s

  # cAdvisor - Container metrics
  - job_name: 'cadvisor'
    static_configs:
      - targets:
        - 'cadvisor:8080'
    scrape_interval: 30s

  # Docker containers
  - job_name: 'docker-containers'
    static_configs:
      - targets: ['cadvisor:8080']
    metrics_path: /metrics/cadvisor
    scrape_interval: 30s

  # Proxmox nodes
  - job_name: 'proxmox'
    static_configs:
      - targets:
        - '192.168.31.75:9221'  # Helios
        - '192.168.31.208:9221' # Xeon
    scrape_interval: 60s
    metrics_path: /pve
    params:
      module: ['default']

  # Blackbox exporter for service availability
  - job_name: 'blackbox'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
        # Monitoring services
        - http://192.168.31.201:3000  # Grafana
        - http://192.168.31.201:3001  # Uptime Kuma

        # Media services
        - http://192.168.31.151:8096  # Jellyfin
        - http://192.168.31.151:8989  # Sonarr
        - http://192.168.31.151:7878  # Radarr
        - http://192.168.31.151:9696  # Prowlarr

        # Productivity services
        - http://192.168.31.202:8081  # Nextcloud
        - http://192.168.31.202:3000  # Gitea
        - http://192.168.31.202:2283  # Immich

        # Books services
        - http://192.168.31.205:5000  # Kavita
        - http://192.168.31.205:13378 # Audiobookshelf

        # Database management
        - http://192.168.31.203:8080  # Adminer
        - http://192.168.31.203:5050  # PgAdmin

        # Nginx Proxy Manager
        - http://192.168.31.200:81    # NPM Admin
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox:9115

  # Services with built-in metrics
  - job_name: 'jellyfin'
    static_configs:
      - targets: ['192.168.31.151:8096']
    metrics_path: /metrics
    scrape_interval: 60s

  - job_name: 'nextcloud'
    static_configs:
      - targets: ['192.168.31.202:8081']
    metrics_path: /metrics
    scrape_interval: 60s

  # Database metrics
  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['192.168.31.203:9104']
    scrape_interval: 30s

  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['192.168.31.203:9187']
    scrape_interval: 30s

  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['192.168.31.203:9121']
    scrape_interval: 30s

  # Uptime Kuma metrics (if enabled)
  - job_name: 'uptime-kuma'
    static_configs:
      - targets: ['uptime-kuma:3001']
    metrics_path: /metrics
    scrape_interval: 60s

  # Home Assistant
  - job_name: 'home-assistant'
    static_configs:
      - targets: ['192.168.31.204:8123']
    metrics_path: /api/prometheus
    bearer_token: ${HOMEASSISTANT_TOKEN}
    scrape_interval: 30s

# Remote write configuration (optional)
# remote_write:
#   - url: "https://your-prometheus-remote-write-url/api/v1/write"
#     basic_auth:
#       username: your-username
#       password: your-password